name: Build Android APK (S.O.S FeDe)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      # 1️⃣ Descomprimir el ZIP del código
      - name: Unzip Flutter code bundle (auto-detect folder)
        run: |
          set -e
          echo "== Repo root before unzip =="
          ls -la

          echo "== ZIP content =="
          unzip -l diccionario_app_flutter_code_only.zip | head -n 60

          unzip -q diccionario_app_flutter_code_only.zip

          echo "== Repo root after unzip =="
          ls -la

          # Detecta dónde está pubspec.yaml
          SRC_PUBSPEC=$(find . -maxdepth 4 -name pubspec.yaml -print -quit)
          if [ -z "$SRC_PUBSPEC" ]; then
            echo "ERROR: No encuentro pubspec.yaml dentro del ZIP descomprimido"
            exit 2
          fi

          SRC_DIR=$(dirname "$SRC_PUBSPEC")
          echo "SRC_DIR=$SRC_DIR" >> $GITHUB_ENV

          echo "== Detected SRC_DIR =="
          echo "$SRC_DIR"
          ls -la "$SRC_DIR"
          ls -la "$SRC_DIR/lib" || true


      # 2️⃣ Crear proyecto Flutter limpio (android/ válido)
      - name: Create fresh Flutter project
        run: |
          flutter create -t app build_app

      # 3️⃣ Inyectar TU código + CSV externo
      - name: Inject pubspec + lib + assets (auto)
        run: |
          set -e
          echo "Using SRC_DIR=$SRC_DIR"

          # Comprobaciones mínimas
          test -f "$SRC_DIR/pubspec.yaml" || (echo "ERROR: falta $SRC_DIR/pubspec.yaml" && exit 2)
          test -f "$SRC_DIR/lib/main.dart" || (echo "ERROR: falta $SRC_DIR/lib/main.dart" && exit 2)
          test -f "$SRC_DIR/app_icon.png" || (echo "ERROR: falta $SRC_DIR/app_icon.png" && exit 2)
          test -f "diccionario.csv" || (echo "ERROR: falta diccionario.csv en la raíz del repo" && exit 2)

          cp "$SRC_DIR/pubspec.yaml" build_app/pubspec.yaml

          rm -rf build_app/lib
          cp -R "$SRC_DIR/lib" build_app/lib

          mkdir -p build_app/assets
          cp "diccionario.csv" build_app/assets/diccionario.csv


      # 4️⃣ Nombre de la app (launcher)
      - name: Set Android app name (launcher)
        run: |
          set -e
          APP_NAME="S.O.S FeDe"
          STRINGS_FILE="build_app/android/app/src/main/res/values/strings.xml"

          echo "== Checking strings file path =="
          ls -la build_app/android/app/src/main/res || true
          ls -la build_app/android/app/src/main/res/values || true

          # Si no existe, lo creamos (evita exit code 2)
          if [ ! -f "$STRINGS_FILE" ]; then
            echo "strings.xml no existe. Creándolo..."
            mkdir -p "$(dirname "$STRINGS_FILE")"
            cat > "$STRINGS_FILE" <<EOF
          <resources>
          <string name="app_name">$APP_NAME</string>
          </resources>
          EOF
          fi

          # Si existe app_name, lo reemplaza. Si no, lo añade.
          if grep -q 'name="app_name"' "$STRINGS_FILE"; then
            sed -i "s#<string name=\"app_name\">.*</string>#<string name=\"app_name\">$APP_NAME</string>#g" "$STRINGS_FILE"
          else
            sed -i "s#</resources>#  <string name=\"app_name\">$APP_NAME</string>\n</resources>#g" "$STRINGS_FILE"
          fi

          # Asegura que el Manifest usa @string/app_name
          MANIFEST="build_app/android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/g' "$MANIFEST"
          fi

          echo "== strings.xml final =="
          cat "$STRINGS_FILE"
 
      # 5️⃣ Icono de la app
      - name: Set Android launcher icon
        run: |
          ICON="$SRC_DIR/app_icon.png"
          RES="build_app/android/app/src/main/res"

          for d in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            mkdir -p "$RES/$d"
            cp "$ICON" "$RES/$d/ic_launcher.png"
          done


      # 6️⃣ Instalar dependencias
      - name: Flutter pub get
        working-directory: build_app
        run: flutter pub get

      # 7️⃣ Compilar APK
      - name: Build release APK
        working-directory: build_app
        run: flutter build apk --release

      # 8️⃣ Subir APK
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build_app/build/app/outputs/flutter-apk/app-release.apk

        
