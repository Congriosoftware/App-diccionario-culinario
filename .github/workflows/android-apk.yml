name: Build Android APK (S.O.S FeDe)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      # 1️⃣ Descomprimir el ZIP del código
      - name: Unzip Flutter code bundle
        run: |
          unzip -q diccionario_app_flutter_code_only.zip
          ls -la
          ls -la diccionario_app_flutter_offline

      # 2️⃣ Crear proyecto Flutter limpio (android/ válido)
      - name: Create fresh Flutter project
        run: |
          flutter create -t app build_app

      # 3️⃣ Inyectar TU código + CSV externo
      - name: Inject pubspec + lib + assets
        run: |
          cp diccionario_app_flutter_offline/pubspec.yaml build_app/pubspec.yaml

          rm -rf build_app/lib
          cp -R diccionario_app_flutter_offline/lib build_app/lib

          mkdir -p build_app/assets
          cp diccionario.csv build_app/assets/diccionario.csv

      # 4️⃣ Nombre de la app (launcher)
      - name: Set Android app name
        run: |
          APP_NAME="S.O.S FeDe"
          STRINGS="build_app/android/app/src/main/res/values/strings.xml"

          sed -i "s#<string name=\"app_name\">.*</string>#<string name=\"app_name\">$APP_NAME</string>#g" "$STRINGS"

      # 5️⃣ Icono de la app
      - name: Set Android launcher icon
        run: |
          ICON="diccionario_app_flutter_offline/app_icon.png"
          RES="build_app/android/app/src/main/res"

          for d in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            mkdir -p "$RES/$d"
            cp "$ICON" "$RES/$d/ic_launcher.png"
          done

      # 6️⃣ Instalar dependencias
      - name: Flutter pub get
        working-directory: build_app
        run: flutter pub get

      # 7️⃣ Compilar APK
      - name: Build release APK
        working-directory: build_app
        run: flutter build apk --release

      # 8️⃣ Subir APK
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build_app/build/app/outputs/flutter-apk/app-release.apk

        
